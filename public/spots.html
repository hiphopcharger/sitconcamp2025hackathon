<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>新竹景點列表</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
      background-color: #f2f5ff;
    }
    h1 {
      color: #4a61d1;
      text-align: center;
      margin-bottom: 2rem;
    }
    .spot {
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .spot h3 {
      margin: 0 0 0.5rem 0;
      color: #333;
    }
    .spot p {
      margin: 0.3rem 0;
    }
    .day-group {
      margin-bottom: 3rem;
    }
    .day-group h2 {
      color: #3a3a7a;
      margin-bottom: 1rem;
      border-bottom: 2px solid #4a61d1;
      padding-bottom: 0.3rem;
    }
  </style>
</head>
<body>
  <h1>新竹景點列表</h1>
  <div id="spotContainer">資料載入中...</div>

  <script>
  const params = JSON.parse(localStorage.getItem('tripParams') || '{}');
  const city = params.city || '';
  const townships = params.areas || [];
  const indoorPref = params.indoor || 'any';

  const photoCount = parseInt(params.photoCount) || 0;
  const attractionCount = parseInt(params.attractionCount) || 0;
  const restaurantCount = parseInt(params.restaurantCount) || 0;

  const startDateStr = params.startDate || '';
  const endDateStr = params.endDate || '';

  fetch('/hsinchu_spots.json')
    .then(res => res.json())
    .then(data => {
      const container = document.getElementById('spotContainer');
      container.innerHTML = '';

      // 計算旅遊天數
      if (!startDateStr || !endDateStr) {
        container.textContent = '請設定開始與結束日期';
        return;
      }
      const startDate = new Date(startDateStr);
      const endDate = new Date(endDateStr);
      if (endDate < startDate) {
        container.textContent = '結束日期不能早於開始日期';
        return;
      }
      const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

      const totalSpots = photoCount + attractionCount + restaurantCount;
      if (totalSpots < days) {
        container.textContent = `景點總數 (${totalSpots}) 必須大於等於旅遊天數 (${days})`;
        return;
      }

      // 過濾縣市、鄉鎮、室內偏好
      let filtered = data.filter(spot => {
        if (city && spot.city !== city) return false;
        if (townships.length > 0 && !townships.includes(spot.township)) return false;
        if (indoorPref === 'indoor' && !spot.indoor) return false;
        if (indoorPref === 'outdoor' && spot.indoor) return false;
        return true;
      });

      // 按類型分類
      const photos = filtered.filter(s => s.type === '拍照');
      const attractions = filtered.filter(s => s.type === '景點');
      const restaurants = filtered.filter(s => s.type === '餐廳');

      // 各類型隨機抽樣指定數量（不足就全取）
      const selectedPhotos = shuffleArray(photos).slice(0, photoCount);
      const selectedAttractions = shuffleArray(attractions).slice(0, attractionCount);
      const selectedRestaurants = shuffleArray(restaurants).slice(0, restaurantCount);

      // 合併所有選中的景點
      let finalList = [...selectedPhotos, ...selectedAttractions, ...selectedRestaurants];

      if (finalList.length === 0) {
        container.textContent = '找不到符合條件的景點';
        return;
      }

      // 洗牌讓分配更隨機
      finalList = shuffleArray(finalList);

      // 按天數分配景點，確保每一天至少一個
      const dailySpots = Array.from({length: days}, () => []);
      finalList.forEach((spot, idx) => {
        dailySpots[idx % days].push(spot);
      });

      // 顯示每日分配的景點
      dailySpots.forEach((spots, dayIndex) => {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + dayIndex);

        const dayDiv = document.createElement('div');
        dayDiv.className = 'day-group';
        dayDiv.innerHTML = `<h2>第 ${dayIndex + 1} 天 （${date.toLocaleDateString()}）</h2>`;

        spots.forEach(spot => {
          const div = document.createElement('div');
          div.className = 'spot';
          div.innerHTML = `
            <h3>${spot.name}</h3>
            <p><strong>描述：</strong>${spot.description}</p>
            <p><strong>縣市：</strong>${spot.city}</p>
            <p><strong>鄉鎮：</strong>${spot.township}</p>
            <p><strong>類型：</strong>${spot.type}</p>
            <p><strong>場地：</strong>${spot.indoor ? '室內' : '室外'}</p>
            <p><strong>價格：</strong>${spot.price} 元</p>
            <p><strong>歇業日：</strong>${spot.close_days.length > 0 ? spot.close_days.join(', ') : '無'}</p>
          `;
          dayDiv.appendChild(div);
        });

        container.appendChild(dayDiv);
      });

    })
    .catch(e => {
      console.error(e);
      document.getElementById('spotContainer').textContent = '資料載入失敗';
    });

  // 洗牌函數
  function shuffleArray(array) {
    const arr = array.slice();
    for (let i = arr.length -1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  </script>
</body>
</html>
