<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>新竹旅遊行程</title>
  <style>
    body.second_page {
      background-color: #d5e0fa;
      font-family: "Segoe UI", "Noto Sans TC", system-ui, sans-serif;
      margin: 0;
      padding: 0;
    }

    .second_page_top_title {
      padding: 20px;
      margin: 10px;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      background-color: #6f9dff;
      color: #ffffff;
      font-size: 42px;
      font-weight: 700;
      text-align: center;
      letter-spacing: 1px;
    }

    .second_page_main {
      display: flex;
      gap: 10px;
      padding: 10px;
      margin: 0 10px 20px;
      border-bottom-left-radius: 12px;
      border-bottom-right-radius: 12px;
      background-color: #ffffff;
    }

    .second_page_main_box {
      margin: 10px;
      padding: 16px;
      background-color: #f1e1ff;
      border-radius: 12px;
    }

    .second_page_main_title_l {
      width: 100%;
      font-size: 26px;
      font-weight: 700;
      color: #333;
      text-align: center;
      margin: 30px 0 16px;
      border-bottom: 2px solid #a64def;
      padding-bottom: 6px;
    }

    .viewpoint_card_detail {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      justify-content: flex-start;
      margin-left: 40px;
    }

    .viewpoint_card_detail > div {
      background-color: #ffffff;
      border-radius: 10px;
      padding: 12px 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      width: 280px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .viewpoint_card_detail > div:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }

    .viewpoint_card_text {
      font-size: 16px;
      font-weight: 500;
      color: #222222;
      margin: 6px 0;
      line-height: 1.5;
      word-break: break-word;
    }

    .button_del {
      margin-left: 12px;
      border-radius: 6px;
      background-color: #ffc78e;
      color: #222;
      border: none;
      cursor: pointer;
      padding: 6px 12px;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }

    .button_del:hover {
      background-color: #ffa94d;
    }

    .second_page_main_box_r {
      width: 25%;
    }

    .second_page_main_title_r {
      font-size: 24px;
      font-weight: bold;
      color: #a64def;
      text-align: center;
      margin-bottom: 16px;
    }

    .viewpoint_suggest {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .suggest_card {
      background-color: #ffffff;
      border-radius: 8px;
      padding: 10px 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .suggest_card p {
      margin: 4px 0;
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body class="second_page">
  <h1 class="second_page_top_title">新竹旅遊行程</h1>
  <div class="second_page_main">
    <div class="second_page_main_box" style="width: 75%;">
      <div id="spotContainer">資料載入中...</div>
    </div>
    <div class="second_page_main_box second_page_main_box_r">
      <h1 class="second_page_main_title_r">景點推薦</h1>
      <div id="suggestContainer" class="viewpoint_suggest"></div>
    </div>
  </div>

  <script>
    const params = JSON.parse(localStorage.getItem('tripParams') || '{}');
    const city = params.city || '';
    const townships = params.areas || [];
    const indoorPref = params.indoor || 'any';
    const photoCount = parseInt(params.photoCount) || 0;
    const attractionCount = parseInt(params.attractionCount) || 0;
    const restaurantCount = parseInt(params.restaurantCount) || 0;
    const totalSpots = parseInt(params.totalSpots) || (photoCount + attractionCount + restaurantCount);
    const startDateStr = params.startDate || '';
    const endDateStr = params.endDate || '';
    const peopleCount = parseInt(params.peopleCount || params.people) || 1;
    const totalBudget = parseInt(params.budget) || 0;
    const maxPerPerson = totalBudget / peopleCount;

    fetch('/hsinchu_spots.json')
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('spotContainer');
        const suggest = document.getElementById('suggestContainer');
        container.innerHTML = '';
        suggest.innerHTML = '';

        if (!startDateStr || !endDateStr) {
          container.textContent = '請設定開始與結束日期';
          return;
        }

        const startDate = new Date(startDateStr);
        const endDate = new Date(endDateStr);
        const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

        if (totalSpots < days) {
          container.textContent = `景點總數 (${totalSpots}) 必須大於等於旅遊天數 (${days})`;
          return;
        }

        let filtered = data.filter(spot => {
          if (city && spot.city !== city) return false;
          if (townships.length > 0 && !townships.includes(spot.township)) return false;
          if (indoorPref === 'indoor' && !spot.indoor) return false;
          if (indoorPref === 'outdoor' && spot.indoor) return false;
          return true;
        });

        const photos = filtered.filter(s => s.type === '拍照');
        const attractions = filtered.filter(s => s.type === '景點');
        const restaurants = filtered.filter(s => s.type === '餐廳');

        let valid = false;
        let finalList = [];
        let attempts = 0;

        while (!valid && attempts < 20) {
          const tempPhotos = shuffleArray(photos).slice(0, photoCount);
          const tempAttractions = shuffleArray(attractions).slice(0, attractionCount);
          const tempRestaurants = shuffleArray(restaurants).slice(0, restaurantCount);
          const baseList = [...tempPhotos, ...tempAttractions, ...tempRestaurants];

          const extraCount = totalSpots - baseList.length;
          const remainingSpots = filtered.filter(s => !baseList.includes(s));
          const extraSpots = shuffleArray(remainingSpots).slice(0, extraCount > 0 ? extraCount : 0);
          const tempList = [...baseList, ...extraSpots];

          const totalCost = tempList.reduce((sum, s) => {
            const price = typeof s.price === 'number' ? s.price : parseInt(String(s.price).match(/\d+/)?.[0]) || 0;
            return sum + price;
          }, 0);

          if (totalCost <= maxPerPerson) {
            valid = true;
            finalList = tempList;
            break;
          }
          attempts++;
        }

        if (!valid) {
          container.textContent = '❌ 無符合預算的景點組合';
          return;
        }

        const dailySpots = Array.from({ length: days }, () => []);
        finalList = shuffleArray(finalList);
        finalList.forEach((spot, idx) => {
          dailySpots[idx % days].push(spot);
        });

        dailySpots.forEach((spots, dayIndex) => {
          const date = new Date(startDate);
          date.setDate(startDate.getDate() + dayIndex);

          const dayDiv = document.createElement('div');
          dayDiv.innerHTML = `<h1 class="second_page_main_title_l">——————————— 第 ${dayIndex + 1} 天（${date.toLocaleDateString()}） ———————————</h1>`;

          const cardRow = document.createElement('div');
          cardRow.className = 'viewpoint_card_detail';

          spots.forEach(spot => {
            const card = document.createElement('div');
            card.innerHTML = `
              <h3 class="viewpoint_card_text">${spot.name}</h3>
              <h3 class="viewpoint_card_text">${spot.city} ${spot.township}</h3>
              <h3 class="viewpoint_card_text">${spot.description}</h3>
              <h3 class="viewpoint_card_text">價格：${spot.price} 元</h3>
              <h3 class="viewpoint_card_text">環境：${spot.indoor ? '室內' : '室外'}
                <button class="button_del">移除</button></h3>
            `;
            cardRow.appendChild(card);
          });

          dayDiv.appendChild(cardRow);
          container.appendChild(dayDiv);
        });

        const finalSet = new Set(finalList.map(s => s.name));
        const suggestions = filtered.filter(s => !finalSet.has(s.name));

        suggestions.slice(0, 5).forEach(spot => {
          const suggestDiv = document.createElement('div');
          suggestDiv.className = 'suggest_card';
          suggestDiv.innerHTML = `
            <p><strong>${spot.name}</strong></p>
            <p>${spot.city} ${spot.township}</p>
            <p>${spot.description}</p>
            <p>價格：${spot.price} 元</p>
            <p>環境：${spot.indoor ? '室內' : '室外'}</p>
          `;
          suggest.appendChild(suggestDiv);
        });

      })
      .catch(e => {
        console.error(e);
        document.getElementById('spotContainer').textContent = '資料載入失敗';
      });

    function shuffleArray(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
  </script>
</body>
</html>
